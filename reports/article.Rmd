---
title: "Prediction of 90-day mortality after Total Hip Arthroplasty: a simplified and externally validated model based on observational register data from Sweden, England and Wales"
author: Anne Garland^1,2,3^, Erik Bulow^2,4^, Erik Lenguerrand^5^, Ashley Blom^6^, Mark Wilkinson^7^, Adrian Sayers^8^, Ola Rolfson^2,4^, Nils P. Hailer^1,2^
date: '`r Sys.Date()`'
bibliography: P:/library.bib
csl: the-lancet.csl
output: 
  bookdown::word_document2:
    reference_docx: article.dotx
    toc: false
    df_print: kable
---

```{r setup, include = FALSE}
options(
  digits            = 2,
  knitr.kable.NA    = '',
  repos = list(CRAN = "https://cran.rstudio.com/")
)
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)

# Load all files
walk(file.path("../cache", dir("../cache", ".RData")), load, .GlobalEnv)
source("../lib/clean_names.R")
```

# Affiliation and contact

1.	Department of Orthopaedics, Institute of Surgical Sciences, Uppsala University Hospital, Uppsala, Sweden
2.	Swedish Hip Arthroplasty Register, Gothenburg, Sweden
3.	Department of Orthopaedics, Visby Hospital, Visby, Sweden
4.	Department of Orthopaedics, Institute of Clinical Sciences, The Sahlgrenska Academy, University of Gothenburg, Gothenburg, Sweden
5. Translational Health Sciences, Bristol Medical School, University of Bristol, England.
6. ...
7. ...
8. ...



**Correspondence: [OR EB?]** 
anne.garland@surgsci.uu.se, Phone: +46 498 26 80 00, Postal: Orthopedic Department, Visby Hospital, St Goransgatan 10, 621 84 Visby, Sweden  


##### PAGE BREAK

# Abstract

**OBJECTIVE:** Shared decision making is essential before total hip arthroplasty (THA) surgery. Comorbidities are associated with an increased risk of 90-day morbidity and mortality, but diagnosis code-based instruments such as the Charlson or Elixhauser comorbidity indices are impossible to use in a clinical setting, and the American Society for Anesthesiologists (ASA) grade is imprecise. We searched for a simple model to predict early mortality after THA. 

**PATIENTS AND METHODS:** We studied `r format(nrow(df), big.mark = ",")` Swedish patients operated with a cemented THA due to primary osteoarthritis and linked data from several national registries in order to collect information on demographics and comorbidities. Bootstrap ranking procedures were used together with logistic LASSO regression to develop prediction models for death within 90 days. Predictive accuracy was assessed by the areas under the receiver operating characteristic curve (AUC). The final model was externally validated on a data-set from the National Joint Registry of England and Wales .

```{r}
get_auc <- function(mod) {
  subset(brlasso_tbl_auc, Model == mod, "AUC", drop = TRUE) %>% 
    {gsub("(", "(95% CI: ",., fixed = TRUE)}
}
```


**RESLUTS:** The unadjusted cumulative 90-day mortality was `r surv90d`. Best predictive performance for 90-day mortality was found for a model combining `r coefs_print_reduced` (AUC = `r get_auc("BRL reduced (age as main effect)")`). This model was superior to the  Charlson (AUC = `r get_auc("Charlson")`) and Elixhauser (AUC = `r get_auc("Elixhauser")`) comorbidity measures. A web calculator to aid clinical usage was published at https://erikbulow.shinyapps.io/thamortpred/ **[Would it be possible to embedd it at shpr.se instead?]**.
  
**CONCLUSION:** We found a relatively simple prediction model of 90-day mortality after THA. This model requires less data and is easier to use compared to previously well-known comorbidity indices.


##### PAGE BREAK

# Introduction

Shared decision making has evolved into an integral part of patient-physician interactions prior to surgical interventions, and the weighing of risks against benefits is central to this process. In terms of gained quality of life and cost-utility, total hip arthroplasty (THA) is an enormously successful procedure, but the risk of adverse events in the short and long term is an essential part of preoperative discussions and various risk prediction models have been developed.[@Price2019]

90-day mortality after THA surgery performed due to osteoarthritis is low, ranging between 0.2% and 0.6% in large joint registry analyses where adjustment for comorbidities is possible.[@Hunt2013; @Garland2017]  

The presence of comorbidities is associated with a shorter remaining life span, but the Charlson and Elixhauser comorbidity indices poorly predict mortality after THA and total knee arthroplasty.[@Bulow2017; @Inacio2015] Additionally, these complex comorbidity instruments are based on the availability of extensive data-sets including in- and outpatient data coded by the 10th revision of the international classification of diseases (ICD-10), and each of the comorbidity indices exists in numerous versions.[@Brusselaers2017; @Walraven2009] Interpretation and comparison of different studies is therefore difficult.

Comorbidity data are used to construct universal or arthroplasty-specific risk prediction tools, but no model has so far been broadly accepted to predict mortality after  elective THA.[@Manning2016; @Bulow2017] In order to propel arthroplasty surgery into the age of precision medicine, easily applicable tools to predict short- and long-term complications are urgently needed. We aimed to define a model that accurately predicts the risk of 90-day postoperative mortality after THA.



# Patients and Methods

Patients recorded in the Swedish Hip Arthroplasty Register (SHAR) with cemented THA due to osteoarthritis `r paste(range(df$P_SurgYear), collapse = " - ")` were used to develop, and internally validate, the prediction model (Figure \@ref(fig:flowchart)). Data from the National Joint Register in England and Wales (NJR) was later used for external validation. 
Only the last operated hip was accounted for in patients with bilateral THA. [@Bulow2019a]  

Data linkage, based on the 10-digit identity numbers assigned to all Swedish residents,[@Ludvigsson2009] were used to collect data from a variety of sources, as previously described.[@Cnudde2016]

Age, sex, body mass index (BMI), the American Society for Anesthesiologists (ASA) grade, type of hospital (university/county/rural/private) and year of surgery were collected from the SHAR, which has a completeness of 96-98%.[@shpr2018] Data on education level (low = up to 9 years/middle = 10-12 years/high = at least 12 years) and civil status (married/un-married/divorced/widow[er]), were collected from the longitudinal integration database for health insurance and labor market studies from Statistics Sweden.[@Ludvigsson2019] The Swedish National Patient Register was used to assess comorbidities during the year preceding index surgery. This register contains all relevant diagnoses coded by ICD-10, as well as dates of admission and discharge for in- and outpatient episodes in all private and public hospitals.[@Ludvigsson2011] Death dates were linked from the national population register.

Comorbidity was defined by individual ICD-10 codes grouped into 17 categories according to Charlson [@Charlson1987; @Deyo1992; @Quan2005] and 31 categories according to Elixhauser.[@Elixhauser1998; @Quan2005]

Some comorbidities were identified by both Charlson and Elixhauser, and some distinct comorbidities were closely related (such as hypertension with and without complications, or abuse of either drugs or alcohol). We therefore combined individual categories to establish `r nrow(tab_categorization)` broader categories of comorbidity (Table \@ref(tab:tabcategorization)). Conditions were merged according to clinical relevance as to be recognized in a patient-doctor meeting without access to external register data. 


## Statistics

We used the Kaplan-Meier estimator to assess unadjusted mortality.

Further analysis were based on logistic regression since no censoring occurred within the 90 day study period. We used a modelling procedure with bootstrap ranking and logistic least absolute shrinkage and selection operator (LASSO) model.[@Guo2015] 
Numeric variables (age and BMI) were normalized before modelling to have mean = 0 and standard deviation = 1. 

Comorbidities recorded for at least one patient who died within 90 days, and one who did not, were included in the modelling process. 1,000 bootstrap samples were drawn from the observed data set.[@Austin2004] We used 10-fold cross validation for every bootstrap sample with a broad range of potential penalty values ($\lambda$:s) in a logistic LASSO model. We then only kept $\lambda$:s minimizing the mean cross-validated deviances in each sample. Those $\lambda$:s were used to estimate model coefficients for each potential predictor. Absolute values from those estimates were used as a measure of variable importance. Piece-wise linear regression was  used to detect a break point where a significant drop in variable importance were observed. Potential predictors with variable importance above this break point were considered important and kept as model candidates. The whole process was repeated 100 times. 

Covariates that were selected at least one out of the 100 times were used in a main effects model of multivariable logistic regression without penalty, and without pre-normalization of numeric variables. We will call this model "BRL" for bootstrap ranking LASSO. A reduced model with variables chosen at least 33 out of the 100 times, is called "BRL reduced". This model, but without cancer as a predictor, was also evaluated, since patients with cancer are sometimes treated differently [NEEDS CLARIFICATION!]. 

Univariable models with the ASA grade, Charlson or Elixhauser comorbidity indices were used for benchmarking, as well as a multivariable model with age and sex. Each model including age was fitted three times, once with age as a main effect and twice with restricted cubic splines, either by two or three knots. 

Each of those models were used to predict the probability of death within 90 days for each patient. Sensitivity and specificity were estimated to form receiver operating characteristic (ROC) curves and the area under those curves (AUC) were used as a measure of predictive accuracy. Models with a lower 95% confidence limit above 0.7, were considered good. Those intervals were based on percentiles from 2,000 non-parametric bootstrap samples for internal validation. The bias-corrected Somers' $D_{xy}$ rank correlation was used to adjust those intervals for optimism based on 100 re-samples.[@Miller1991] Calibration bands were made to graphically assess model calibration.[@Nattino2016]

Odds ratios for the final model were estimated with 95% confidence intervals based on interpolations of profile traces.[@Ripley2002]

We also built an online web calculator available at https://erikbulow.shinyapps.io/thamortpred/. Patients can use it to easily estimate their own risk of mortality. This estimate can be used in a discussion of shared decision making on whether to operate or not.

We used `r substr(R.version.string, 1, 15)` (R Foundation for Statistical   Computing, Vienna, Austria) with significant packages tidyverse, tidymodels, furrr, pROC and shiny. All R-scripts and necessary configurations (but no personal data) is available at zenodo.org/XXX. A linked Binder environment is also available for interactive usage.

## Ethical approval

Ethical approval for this study was obtained from the Regional Ethical Review Board in Gothenburg (271-14 and 360-13).
**[COI?]**


# Results

After application of exclusion criteria, `r format(nrow(df), big.mark = ",")` patients (age `r paste(range(df$P_Age), collapse = " - ")`, `r round(mean(df$P_Sex == "Female") * 100)`% females) were included in the analysis (Figure \@ref(fig:flowchart)). `r with(df, sprintf("%d (%.2f%%)", sum(death90), mean(death90) * 100))` patients died within 90 days and no one was censored before that. The unadjusted risk of 90 day mortality was `r surv90d`. 

Characteristics of the study population are presented in Table \@ref(tab:tab1). `r round(mean(df$CCI_index_quan_original != 0) * 100)`% of all patients had at least one pre-surgery comorbidity according to Charlson and `r round(mean(df$ECI_index_sum_all  != 0) * 100)`% according to Elixhauser. The proportion of patients with ASA grade 3 was `r round(mean(df$P_ASA == 3) * 100)`%. Most comorbidities were more common among patients who died. 

There were `r nrow(comb_lgl)` comorbidities that were not recorded for any patient who died: `r comb_lgl_text`, and these variables were thus excluded from the modelling process.

The "BRL" model included `r coefs_print`. The "BRL reduced" model only used `r coefs_print_reduced` (Table \@ref(tab:brlprop)).

We observed no relevant differences between models based on age described by restricted cubic splines with two versus three knots and therefore only present results for models based on three knots. The use of splines did however not improve the accuracy of the models when compared to simpler main effect models. The "BRL" model had an estimated AUC of `r get_auc("BRL (age as main effect)")`, and the reduced version performed equally good with AUC `r get_auc("BRL reduced (age as main effect)")`. Univariable models with ASA grade, Charlson or Elixhauser performed poorly with an AUC that was lower than 0.7. A model based on only age and sex performed slightly better but still with an AUC not statistically significantly above 0.7 (Table \@ref(tab:auc) and Figure \@ref(fig:rocs)). 

AUCs and 95% confidence intervals, with and without adjustments for optimism, are illustrated for some models in Figure \@ref(fig:aucci)). 

The ability of the "BRL reduced" model to estimate probabilities of death within 90 days is illustrated in Figure \@ref(fig:sep). Patients who died had, on average, higher predicted probabilities to do so. The model calibration was good for probabilities up to 3%, while higher probabilities might be over-estimated (Figure \@ref(fig:calibration)). 

Estimated coefficients and corresponding odds ratios for the "BRL reduced" model is presented in Table \@ref(tab:brlreduced).


# Discussion

We found that a multivariable main effects logistic regression model with `r coefs_print_reduced` was able to better predict 90-day mortality than more complex models such as the Charlson or Elixhauser comorbidity indices. 

The resulting "BRL reduced" model can predict the probability of death within 90 days as: $p = 1 / [1 +\exp(\beta X)]$ where `r coefs_form`
This formula is valid for patients within the observed age range (`r paste(range(df$P_Age), collapse = " - ")` years) with observed combinations of diseases.

```{r}
get_risk <- function(who) people[people$id == who, "p", drop = TRUE]
```

For example a `r min(df$P_Age)` year old woman with ASA grade = 1 and none of the important comorbidities would have a `r get_risk("baseline")` risk to die within 90 days of surgery. Another woman, `r quantile(df$P_Age, .25)` years old (the first age quantile), have an elevated risk of `r get_risk("healthy_female")`. A `r quantile(df$P_Age, .75)` years old man (the third age quantile) with ASA grade = 3 and a previous heart condition would have a risk of `r get_risk("sicker_man")`. If that man was instead 99 years old (the maximum observed age), with cancer as well, his risk would be `r get_risk("sickest_man")`. Note however that observed covariate patters with predicted probabilities above 3% were rare. Only `r mean(pred_probs > 3) * 100`% (`r sum(pred_probs > 3)` patients) had those (Figure \@ref(fig:sep)). Estimated mortality risks above 3% are therefore subject to extrapolation. Some risk calculators ignore this problem,[@Bozic2013a] but we think this should be acknowledged.

Obesity in the "BRL reduced" model was not statistically significant by itself ($p =$ `r subset(brlasso_tbl_coefs, term == "Obesity", "p", drop = TRUE)`) but is relevant as a predictor due to unobserved heterogeneity.[@Mood2010] We note that the proportion of patients with BMI above 30, the definition of obisity (`r mean(df$P_BMI > 30, na.rm = TRUE) * 100`%) is much higher than the proportion of patients with ICD-10 = E66* (obesity) from the national patient register (`r mean(df$c_obesity) * 100`%). This proportion corresponds to patients with BMI of at least `r which.min(map_dbl(1:50, ~mean(df$P_BMI > ., na.rm = TRUE)) > mean(df$c_obesity))`. Thus, obesity might be indicated in the risk calculator only if the condition is severe. 

The "BRL reduced" model without cancer had the same AUC as a model with cancer. The AUC value itself is a rank-based and scale-invariant measure that does not account for model calibration. Both models were however equally well calibrated as well, for estimated probabilities within the recommended range (0-3%). The model without cancer however performed worse for probabilities above 3%.

It is known that male sex is associated with earlier deaths and that the remaining life span will decrease with increased age. It is less obvious that this relation must be linear. We used restricted cubic splines to allow a more flexible relation, but found that a linear relationship was equally good. Our model includes ASA grade, which is routinely assessed pre-operatively in most developed countries. It is however known to have a high degree of internal variability.[@Haynes1995] It has previously been compared to the Charlson comorbidity index, but not with respect to mortality after THA.[@Whitmore2014; @Kork2015] Patients with ASA grade 4-6 were excluded since those categories describe severe disease, moribund and brain-dead individuals. Patients with those conditions are unlikely to get elective THA. 

Comorbidity burden is also known to influence the outcome after THA.[@Inacio2015; @Gordon2013; @Hofstede2016; @Garland2017] Coding algorithms on the other hand are complex and not used in clinical settings since the administrative burden is too high. The Charlson classification comprise 1,178 ICD-10 codes and the Elixhauser 1,516. Those indices are therefore only used by researchers.

Risk prediction may be useful in the process of patient selection prior to surgery, in the preoperative risk management including a review of current medications, and in perioperative anesthesia management. A number of risk prediction tools of various complexity for adverse events after total joint replacements have been introduced but none has been broadly accepted.[@Manning2016; @Price2019] In the context of trauma surgery, outcome prediction tools are common, and it seems possible to reduce the number of items without losing predictive accuracy.[@Gerdin2016] Our results indicate that the risk of early postoperative mortality after THA could be assessed by a relatively simple prediction model.

A strength of this study is the nationwide design with a large cohort of primary THA patients. We were able to use exact data linkage by the Swedish identity numbers and had no censoring. Our data sources are valid with low proportions of missing data.[@Soderman2000; @shpr2018; @Soderman2001; @Ludvigsson2011]

The risk of coding errors might be a limitation to the study, especially so if coding routines change over time. It should also be remembered that the risk model does not study THA as an observed intervention. We merely followed the cohort who did already have THA. Hence, deaths within 90 days might occur for the patients regardless if THA is inserted or not. The proximity in time however, the maximum of 90 days from THA to death, is an indication that the operation might have influenced the deaths observed. The insertion of an elective THA is always preceded by a clinical judgement. Hence, no patient with a foreseen death near-by is given THA to begin with. We therefore believe that at least a non-significant proportion of deaths within 90 days are related to  THA. 

We hope that the supplied web calculator and the transparent reporting of this model might lead to clinical usage that can be part of a pre-surgery discussion between doctors and patients in need of THA.

# Contribution of authors

**[ADD NJR CONTRIBUTIONS!]** AG and NH initiated the study and managed the ethical review board application. EB developed the statistical model. EL and AS performed external validation with data from NJR. AG and EB drafted the manuscript. All authors edited and finalized the manuscript.


# Acknowledgement

We would like to thank Szilard Nemes, previous senior statistician at the Swedish Hip Arthroplasty Register, for involvement in planning and interpreting the study.

##### PAGE BREAK

```{r, child = "figs_tabs.Rmd"}
```

##### PAGE BREAK

# Bibliography
